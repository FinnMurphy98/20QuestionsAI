{% extends "base.html" %}

{% block content %}
<div class="card">
    <h1>New game as the {{ role }}!</h1>
    <div id="chat-box">
        <div id="chat-history", style="max-width: 400px;">
            <!-- display chat history here -->
           
            <div class="message">
                <p class="game-user">{{ current_user.username }}</p> 
                <p class="user-message">{{ prompt }}</p>
            </div> 
            <div class="message">
                <p class="game-gpt">ChatGPT</p> 
                <p class="gpt-message">{{ reply }}</p>
            </div>
        </div> 
        <div id="chat-input">
            <input type="text" id="message-input" placeholder="Type your message here...">
            <button class="send" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        <p>{{ form.winner() }} {{ form.winner.label }}</p>
        <div class="finish"><p >{{ form.submit() }}</p></div>
    </form>
</div>


<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.min.js"></script>
<script>
 
    var socket = io.connect('http://127.0.0.1:5000/game/' + '{{ role }}');


    socket.on('connect', function() {
        console.log('Connected to server');
    });

    socket.on('message', function(data) {
        var role = data.role;
        var content = data.content;
        var reply = data.reply;
        addMessageToChatBox(role, content, reply);
    });
    

    function sendMessage() {
        var messageInput = document.getElementById('message-input');
        var message = messageInput.value;

        addMessageToChatBox('user', message, null);

        socket.emit('message', { message: message });

        messageInput.value = '';
    }

    function addMessageToChatBox(role, content, reply) {
        var chatHistory = document.getElementById('chat-history');
        var messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        
        var userMessage = document.createElement('p');
        userMessage.classList.add('user-message');
        userMessage.textContent = content;
        
        var gameUser = document.createElement('p');
        gameUser.classList.add('game-user');
        gameUser.textContent = '{{ current_user.username }}';
        
        messageDiv.appendChild(gameUser);
        messageDiv.appendChild(userMessage);
        
        if (reply) {
            var replyDiv = document.createElement('div');
            replyDiv.classList.add('message');
            
            var gptMessage = document.createElement('p');
            gptMessage.classList.add('gpt-message');
            gptMessage.textContent = reply;
            
            var gameGPT = document.createElement('p');
            gameGPT.classList.add('game-gpt');
            gameGPT.textContent = 'ChatGPT';
            
            replyDiv.appendChild(gameGPT);
            replyDiv.appendChild(gptMessage);
            
            messageDiv.appendChild(replyDiv);
        }
        
        chatHistory.appendChild(messageDiv);
    }
    
    

</script>
{% endblock %}
