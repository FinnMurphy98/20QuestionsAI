{% extends "base.html" %}

{% block content %}
<div class="card">
    <h1>New game as the {{ role }}!</h1>
    <div id="chat-box">
        <div id="chat-history", style="max-width: 400px;">
            <!-- display chat history here -->
           
            <div class="message">
                <p class="game-user">{{ current_user.username }}</p> 
                <p id="initial-user-message" class="user-message">{{ prompt }}</p>
            </div> 
            <div class="message">
                <p class="game-gpt">ChatGPT</p> 
                <p id="initial-gpt-message" class="gpt-message">{{ reply }}</p>
            </div>
        </div> 
        <div id="chat-input">
            <input type="text" id="message-input" placeholder="Type your message here...">
            <button class="send" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        <p>{{ form.winner() }} {{ form.winner.label }}</p>
        <div class="finish"><p >{{ form.submit() }}</p></div>
    </form>
</div>


<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.min.js"></script>
<script>

    var socket = io.connect('http://127.0.0.1:5000/game/' + '{{ role }}');
var currentUsername = '{{ current_user.username }}';

socket.on('connect', function() {
    console.log('Connected to server');
});

socket.on('message', function(data) {
    var content = data.message;
    addMessageToChatBox('ChatGPT', content, null);
});

function sendMessage() {
    var messageInput = document.getElementById('message-input');
    var message = messageInput.value;

    addMessageToChatBox('user', message, null);

    socket.emit('message', { message: message });

    messageInput.value = '';
}

function addMessageToChatBox(role, content, reply) {
    var chatHistory = document.getElementById('chat-history');
    var messageDiv = document.createElement('div');
    messageDiv.classList.add('message');

    var userMessageDiv = document.createElement('div');
    userMessageDiv.classList.add((role === 'user') ? 'user-message' : 'gpt-message');

    var userMessageRole = document.createElement('span');
    userMessageRole.classList.add('game-role');
    userMessageRole.textContent = (role === 'user') ? currentUsername : 'ChatGPT';

    var userMessageContent = document.createElement('p');
    userMessageContent.classList.add('message-content');
    userMessageContent.textContent = content;

    userMessageDiv.appendChild(userMessageRole);
    userMessageDiv.appendChild(userMessageContent);
    messageDiv.appendChild(userMessageDiv);

    chatHistory.appendChild(messageDiv);
}
</script>
{% endblock %}
